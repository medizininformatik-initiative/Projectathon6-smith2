---
title: "DQ report - SMITH"
output:
  html_document:
    df_print: paged
---


```{r include=FALSE}
### LIBRARIES ------------------------
library(knitr)
library(dataquieR)
library(data.table)

```

```{r include=FALSE}
### READ DATA -------------------

if(!file.exists("Ergebnisse\\Kohorte.csv")){
  write("Ergebnisse nicht gefunden.", file ="errors/error_message.txt")
  stop("Results not found - aborting.")
}

# read result csv
cohort_report <- read.csv("Ergebnisse\\Kohorte.csv", sep = ";", colClasses = "character")

# read metadata
metadata_report <- read.csv("DQ_metadata\\metadata.csv")
checks_report <- read.csv("DQ_metadata\\contradictions.csv")
missings_report <- read.csv("DQ_metadata\\missing-codes.csv")

# select columns supported with metadata from cohort
if(!all( metadata_report$VAR_NAMES %in% colnames(cohort_report) )){
  write("Metadaten passen nicht zur Kohorte.", file ="errors/error_message.txt")
  stop("Metadata does not match Cohort - aborting.")
}
cohort_report <- cohort_report[,metadata_report$VAR_NAMES]

#extract known data types
datatyp_report <- as.data.table(t(metadata_report$DATA_TYPE))
colnames(datatyp_report) <- metadata_report$VAR_NAMES

#extract known value labels
value_labels <- as.data.table(t(metadata_report$VALUE_LABELS[3:7]))
colnames(value_labels) <- metadata_report$VAR_NAMES[3:7]
# function that returns only labels in string as list
get_labels <- function(string) {
  # regex to split at | num = : \s?\|?\s?\d\s\=\s 
  # [-1] removes 1 = at start
  return(strsplit(string, "\\s?\\|?\\s?\\d\\s\\=\\s")[[1]][-1])
}
value_labels <- sapply(value_labels, get_labels)

#set up missing codes
missing_unknown <- missings_report$CODE_VALUE[2]
missing_float <- missings_report$CODE_VALUE[3]
missing_integer <- missings_report$CODE_VALUE[4]
missing_datetime <- missings_report$CODE_VALUE[5]
missing_string <- missings_report$CODE_VALUE[6]
missing_label <- missings_report$CODE_VALUE[7]


### Transform to dataquiR format -------------------

# function that sets integer values according to labels and missing codes
apply_labels <- function(vector, labels) {
  # encode unknown labels with 'other'
  # 'other' has to be first in list!
  not_found <- missing_label
  found_offset <- 0
  # if 'other' is a meaningful label use missing code instead
  # see DQ_metadata\\missing_codes.csv
  if(labels[1] == "other") { 
    labels <- labels[-1]
    not_found <- 1
    found_offset <- 1
  }
  
  # unify casing, trim whitespace
  vector <- tolower(vector)
  labels <- tolower(labels)
  vector <- trimws(vector, which = "both")
  labels <- trimws(labels, which = "both")
  
  r <- NULL
  for(item in vector) {
    if(item == "") item <- missing_unknown  
    else {
      i <- 0
      item_start <- item
      for(l in labels) {
        i <- i + 1
        if(item == l) item <- i + found_offset
      }
    }
    if(item == item_start) item <- not_found
    r <- c(r,item)
  }
  
  return(r)
}

#apply labels and fix typing per column
cohort_report$NTproBNP.date <- as.Date(cohort_report$NTproBNP.date)
cohort_report$NTproBNP.valueQuantity.value <- as.double(cohort_report$NTproBNP.valueQuantity.value)
cohort_report$NTproBNP.code <- as.integer( apply_labels(cohort_report$NTproBNP.code, value_labels$NTproBNP.code) )
cohort_report$NTproBNP.codeSystem <- as.integer(  apply_labels(cohort_report$NTproBNP.codeSystem, value_labels$NTproBNP.codeSystem) )
cohort_report$NTproBNP.unit <- as.integer( apply_labels(cohort_report$NTproBNP.unit, value_labels$NTproBNP.unit) )
cohort_report$NTproBNP.unitSystem <- as.integer( apply_labels(cohort_report$NTproBNP.unitSystem, value_labels$NTproBNP.unitSystem) )
cohort_report$gender <- as.integer( apply_labels(cohort_report$gender, value_labels$gender) )
cohort_report$birthdate <- as.Date(cohort_report$birthdate)
cohort_report$encounter.start <- as.Date(cohort_report$encounter.start)
cohort_report$encounter.end <- as.Date(cohort_report$encounter.end)

# verify correct typing
#sapply(cohort_report, class)

```

```{r include=FALSE}
### GENERATE REPORTS ----------------------
#import missing list

smith_dq_report <- dq_report(study_data = cohort_report,
                          meta_data  = metadata_report,
                          check_table = checks_report,
                          MISSING_LIST = missings_report,
                          label_col  = LABEL)

```

## Data Quality report for the 6. Projectathon of MII: SMITH

#### This report was created with the [dataquieR](https://dataquality.ship-med.uni-greifswald.de/tutorials2.html) Package for R.

## Result of contradiction checks:  
```{r message=FALSE, warning=FALSE,echo=FALSE}

smith_dq_report$long_format$con_contradictions$results[[1]]$SummaryPlot


```

### Contradiction checks as Table:

```{r message=FALSE, warning=FALSE,echo=FALSE}

smith_dq_report$long_format$con_contradictions$results[[1]]$SummaryTable

```

## Results of limit checks:  
```{r message=FALSE, warning=FALSE,echo=FALSE}

smith_dq_report$long_format$con_limit_deviations$results[[1]]$SummaryPlotList$ntprobnp

```

### Limit checks as Table:

```{r message=FALSE, warning=FALSE,echo=FALSE,out.width="100%"}

smith_dq_report$long_format$con_limit_deviations$results[[1]]$SummaryTable

```

# Information about distribution:  
  
```{r message=FALSE, warning=FALSE,echo=FALSE}
## Age:
#smith_dq_report$long_format$con_limit_deviations$results[[1]]$SummaryPlotList$birthdate

```

## Gender:  
#### 1 = male | 2 = female | 3 = other | 4 = unknown  
```{r message=FALSE, warning=FALSE,echo=FALSE}

smith_dq_report$long_format$con_limit_deviations$results[[1]]$SummaryPlotList$gender

```

## LOINC Codes:  
#### 1 = other | 2 = 33763-4 | 3 = 71425-3 | 4 = 33762-6 | 5 = 83107-3 | 6 =  83108-1 | 7 = 77622-9 | 8 = 77621-1 
```{r message=FALSE, warning=FALSE,echo=FALSE}

smith_dq_report$long_format$con_limit_deviations$results[[1]]$SummaryPlotList$NTproBNP.code

```


# Information about completness: 

```{r message=FALSE, warning=FALSE,echo=FALSE,out.width="100%"}

#Plot
#smith_dq_report$long_format$com_item_missingness$results[[1]]$SummaryPlot
smith_dq_report$long_format$com_item_missingness$results[[1]]$SummaryTable

```

# Further possible analysis with dataquieR:    
```{r message=FALSE, warning=FALSE,echo=FALSE,out.width="100%"}

smith_dq_report$app_mat$ApplicabilityPlot

```